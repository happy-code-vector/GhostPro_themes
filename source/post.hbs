{{!< default}} {{!-- The tag above means: insert everything in this file into the body of the default.hbs template --}}
    {{!-- Supabase JS Client --}} <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2">
    </script>

    {{!-- Gating Styles --}}
    <style>
        /* Hide content by default until auth check completes */
        .gh-gated-content {
            display: none;
        }

        .gh-gated-content.is-locked {
            display: block;
            filter: blur(12px);
            pointer-events: none;
            opacity: 0.4;
            user-select: none;
        }

        .gh-gated-content.is-unlocked {
            display: block;
            filter: none;
            pointer-events: auto;
            opacity: 1;
        }

        .gh-gate-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 9998;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .gh-gate-overlay.is-visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gh-gate-modal {
            position: relative;
            background: #fff;
            padding: 48px 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 420px;
            width: 90%;
        }

        .gh-gate-modal h2 {
            margin: 0 0 12px;
            font-size: 2.4rem;
            font-weight: 700;
            color: #15171a;
        }

        .gh-gate-modal p {
            margin: 0 0 24px;
            font-size: 1.5rem;
            color: #505050;
            line-height: 1.5;
        }

        .gh-gate-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .gh-gate-input {
            padding: 14px 18px;
            font-size: 1.6rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s;
        }

        .gh-gate-input:focus {
            border-color: var(--ghost-accent-color, #3db4f2);
        }

        .gh-gate-btn {
            padding: 14px 24px;
            font-size: 1.6rem;
            font-weight: 600;
            color: #fff;
            background: var(--ghost-accent-color, #3db4f2);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .gh-gate-btn:hover {
            opacity: 0.9;
        }

        .gh-gate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .gh-gate-btn-secondary {
            background: transparent;
            color: #505050;
            border: 1px solid #e0e0e0;
        }

        .gh-gate-btn-secondary:hover {
            background: #f5f5f5;
        }

        .gh-gate-buttons {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .gh-gate-buttons .gh-gate-btn {
            flex: 1;
        }

        .gh-gate-toggle {
            margin-top: 20px;
            font-size: 1.4rem;
            color: #707070;
        }

        .gh-gate-toggle a {
            color: var(--ghost-accent-color, #3db4f2);
            cursor: pointer;
            text-decoration: underline;
        }

        .gh-gate-error {
            margin-top: 12px;
            padding: 10px;
            font-size: 1.4rem;
            color: #c0392b;
            background: #fdeaea;
            border-radius: 6px;
            display: none;
        }

        .gh-gate-error.is-visible {
            display: block;
        }

        .gh-gate-success {
            margin-top: 12px;
            padding: 10px;
            font-size: 1.4rem;
            color: #27ae60;
            background: #eafaf1;
            border-radius: 6px;
            display: none;
        }

        .gh-gate-success.is-visible {
            display: block;
        }

        /* Loading spinner */
        .gh-gate-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .gh-gate-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e0e0e0;
            border-top-color: var(--ghost-accent-color, #3db4f2);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .gh-gate-view {
            display: none;
        }

        .gh-gate-view.is-active {
            display: block;
        }

        /* DocSend iframe container */
        .gh-docsend-container {
            width: 100%;
            min-height: 80vh;
            margin-top: 24px;
        }

        .gh-docsend-container iframe {
            width: 100%;
            height: 80vh;
            border: none;
            border-radius: 8px;
        }
    </style>

    {{#post}}

    <main class="gh-main">

        <article class="gh-article {{post_class}}">

            <header class="gh-article-header gh-canvas">

                {{#if primary_tag}}
                <a class="gh-article-tag" href="{{primary_tag.url}}">{{primary_tag.name}}</a>
                {{/if}}
                <h1 class="gh-article-title is-title">{{title}}</h1>
                {{#if custom_excerpt}}
                <p class="gh-article-excerpt is-body">{{custom_excerpt}}</p>
                {{/if}}

                {{#if @custom.show_post_metadata}}
                <div class="gh-article-meta">
                    <div class="gh-article-author-image instapaper_ignore">
                        {{#foreach authors}}
                        {{#if profile_image}}
                        <a href="{{url}}">
                            <img class="author-profile-image" src="{{img_url profile_image size=" xs"}}" alt="{{name}}">
                        </a>
                        {{else}}
                        <a href="{{url}}">{{> "icons/avatar"}}</a>
                        {{/if}}
                        {{/foreach}}
                    </div>
                    <div class="gh-article-meta-wrapper">
                        <h4 class="gh-article-author-name">{{authors}}</h4>
                        <div class="gh-article-meta-content">
                            <time class="gh-article-meta-date" datetime="{{date format=" YYYY-MM-DD"}}">{{date
                                format="DD MMM YYYY"}}</time>
                            {{#if reading_time}}
                            <span class="gh-article-meta-length"><span class="bull">â€”</span> {{reading_time}}</span>
                            {{/if}}
                        </div>
                    </div>
                </div>
                {{/if}}

                {{> "feature-image"}}

            </header>

            {{!-- Gated Content Section --}}
            <section id="gh-gated-content"
                class="gh-content gh-canvas is-body gh-gated-content is-locked{{#if @custom.enable_drop_caps_on_posts}} drop-cap{{/if}}">
                {{content}}
            </section>

            {{!-- DocSend Container (shown after access granted) --}}
            <div id="gh-docsend-container" class="gh-docsend-container gh-canvas" style="display: none;"></div>

        </article>

        {{#if comments}}
        <div class="gh-comments gh-canvas">
            {{comments}}
        </div>
        {{/if}}

    </main>

    {{!-- Gate Overlay Modal --}}
    <div id="gh-gate-overlay" class="gh-gate-overlay is-visible">
        <div class="gh-gate-modal">
            {{!-- Loading View --}}
            <div id="gh-gate-loading" class="gh-gate-view is-active">
                <div class="gh-gate-loading">
                    <div class="gh-gate-spinner"></div>
                    <p style="margin: 0;">Checking access...</p>
                </div>
            </div>

            {{!-- Request Briefing View --}}
            <div id="gh-gate-request" class="gh-gate-view">
                <h2>Request Briefing</h2>
                <p>Enter your email to access this intelligence report.</p>
                <form id="gh-gate-request-form" class="gh-gate-form">
                    <input type="email" id="gh-gate-email" class="gh-gate-input" placeholder="your@email.com" required>
                    <button type="submit" class="gh-gate-btn">Get Access</button>
                </form>
                <div id="gh-gate-request-error" class="gh-gate-error"></div>
                <div id="gh-gate-request-success" class="gh-gate-success"></div>
                <p class="gh-gate-toggle">Already a partner? <a id="gh-toggle-login">Sign in here</a></p>
            </div>

            {{!-- Partner Login View --}}
            <div id="gh-gate-login" class="gh-gate-view">
                <h2>Partner Login</h2>
                <p>Enter your email to receive a magic link.</p>
                <form id="gh-gate-login-form" class="gh-gate-form">
                    <input type="email" id="gh-gate-login-email" class="gh-gate-input" placeholder="your@email.com"
                        required>
                    <button type="submit" class="gh-gate-btn">Send Magic Link</button>
                </form>
                <div id="gh-gate-login-error" class="gh-gate-error"></div>
                <div id="gh-gate-login-success" class="gh-gate-success"></div>
                <p class="gh-gate-toggle">New here? <a id="gh-toggle-request">Request access</a></p>
            </div>

            {{!-- Typeform Redirect Confirmation (Wall #1) --}}
            <div id="gh-gate-typeform" class="gh-gate-view">
                <h2>Unlock More Reports</h2>
                <p>You've accessed your free report. Complete a quick feedback form to unlock 2 more reports.</p>
                <div class="gh-gate-buttons">
                    <button id="gh-typeform-cancel" class="gh-gate-btn gh-gate-btn-secondary">Maybe Later</button>
                    <button id="gh-typeform-confirm" class="gh-gate-btn">Continue</button>
                </div>
            </div>

            {{!-- Calendly Redirect Confirmation (Wall #2) --}}
            <div id="gh-gate-calendly" class="gh-gate-view">
                <h2>Ready for Unlimited Access?</h2>
                <p>You've explored our reports. Schedule a quick intro call to unlock unlimited access to all briefings.
                </p>
                <div class="gh-gate-buttons">
                    <button id="gh-calendly-cancel" class="gh-gate-btn gh-gate-btn-secondary">Maybe Later</button>
                    <button id="gh-calendly-confirm" class="gh-gate-btn">Schedule Call</button>
                </div>
            </div>
        </div>
    </div>

    {{/post}}

    {{#if @custom.show_related_articles}}
    {{#get "posts" include="authors" filter="id:-{{post.id}}" limit="4" as |next|}}
    {{#if next}}
    <section class="gh-container is-grid gh-outer">
        <div class="gh-container-inner gh-inner">
            <h2 class="gh-container-title">Read more</h2>
            <div class="gh-feed">
                {{#foreach next}}
                {{> "post-card" lazyLoad=true}}
                {{/foreach}}
            </div>
        </div>
    </section>
    {{/if}}
    {{/get}}
    {{/if}}

    {{!-- Gating Logic Script --}}
    <script>
        (function () {
            // ============================================
            // CONFIGURATION
            // ============================================
            const SUPABASE_URL = 'https://ohwoclsqlwnchtjtylxj.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9od29jbHNxbHduY2h0anR5bHhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MTY3MTgsImV4cCI6MjA4MDQ5MjcxOH0.U7iz_Dlhei2erTfaNcEn8svZ__RyDwJ4S0LgBd1ipoE';
            const EDGE_FUNCTION_URL = SUPABASE_URL + '/functions/v1';
            const URL_TYPEFORM = 'https://your.typeform.com/to/feedback';
            const URL_CALENDLY = 'https://calendly.com/founder/intro';

            let LIMIT_TIER1 = 1;
            let LIMIT_TIER2 = 3;
            let currentUserEmail = null;

            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // DOM Elements
            const gatedContent = document.getElementById('gh-gated-content');
            const gateOverlay = document.getElementById('gh-gate-overlay');
            const views = {
                loading: document.getElementById('gh-gate-loading'),
                request: document.getElementById('gh-gate-request'),
                login: document.getElementById('gh-gate-login'),
                typeform: document.getElementById('gh-gate-typeform'),
                calendly: document.getElementById('gh-gate-calendly')
            };
            const requestForm = document.getElementById('gh-gate-request-form');
            const loginForm = document.getElementById('gh-gate-login-form');

            const currentSlug = window.location.pathname.replace(/^\/|\/$/g, '');
            const urlParams = new URLSearchParams(window.location.search);
            const promoReport = urlParams.get('promo_report');

            // ============================================
            // VIEW MANAGEMENT
            // ============================================
            function showView(viewName) {
                Object.values(views).forEach(v => v.classList.remove('is-active'));
                if (views[viewName]) {
                    views[viewName].classList.add('is-active');
                }
            }

            function showGate() {
                gateOverlay.classList.add('is-visible');
                gatedContent.classList.add('is-locked');
                gatedContent.classList.remove('is-unlocked');
            }

            function hideGate() {
                gateOverlay.classList.remove('is-visible');
                gatedContent.classList.remove('is-locked');
                gatedContent.classList.add('is-unlocked');
            }

            // ============================================
            // EVENT LISTENERS
            // ============================================
            document.getElementById('gh-toggle-login').addEventListener('click', () => showView('login'));
            document.getElementById('gh-toggle-request').addEventListener('click', () => showView('request'));

            // Typeform confirmation buttons
            document.getElementById('gh-typeform-confirm').addEventListener('click', function () {
                window.location.href = URL_TYPEFORM + '?user_email=' + encodeURIComponent(currentUserEmail);
            });
            document.getElementById('gh-typeform-cancel').addEventListener('click', function () {
                window.location.href = '/';
            });

            // Calendly confirmation buttons
            document.getElementById('gh-calendly-confirm').addEventListener('click', function () {
                window.location.href = URL_CALENDLY;
            });
            document.getElementById('gh-calendly-cancel').addEventListener('click', function () {
                window.location.href = '/';
            });

            // Request Briefing Form
            requestForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                const email = document.getElementById('gh-gate-email').value;
                const btn = requestForm.querySelector('button');
                const errorEl = document.getElementById('gh-gate-request-error');
                const successEl = document.getElementById('gh-gate-request-success');

                btn.disabled = true;
                btn.textContent = 'Sending...';
                errorEl.classList.remove('is-visible');
                successEl.classList.remove('is-visible');

                try {
                    const response = await fetch(EDGE_FUNCTION_URL + '/invite-user', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
                            'apikey': SUPABASE_ANON_KEY
                        },
                        body: JSON.stringify({ email: email })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Failed to send magic link');

                    successEl.textContent = 'Check your email for the magic link!';
                    successEl.classList.add('is-visible');
                    btn.textContent = 'Link Sent!';
                } catch (err) {
                    errorEl.textContent = err.message;
                    errorEl.classList.add('is-visible');
                    btn.disabled = false;
                    btn.textContent = 'Get Access';
                }
            });

            // Partner Login Form
            loginForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                const email = document.getElementById('gh-gate-login-email').value;
                const btn = loginForm.querySelector('button');
                const errorEl = document.getElementById('gh-gate-login-error');
                const successEl = document.getElementById('gh-gate-login-success');

                btn.disabled = true;
                btn.textContent = 'Sending...';
                errorEl.classList.remove('is-visible');
                successEl.classList.remove('is-visible');

                try {
                    const { error } = await supabase.auth.signInWithOtp({
                        email: email,
                        options: { emailRedirectTo: window.location.href }
                    });
                    if (error) throw error;

                    successEl.textContent = 'Check your email for the magic link!';
                    successEl.classList.add('is-visible');
                    btn.textContent = 'Link Sent!';
                } catch (err) {
                    errorEl.textContent = err.message;
                    errorEl.classList.add('is-visible');
                    btn.disabled = false;
                    btn.textContent = 'Send Magic Link';
                }
            });

            // ============================================
            // ACCESS CONTROL
            // ============================================
            function grantAccess(email) {
                console.log('Access granted for:', email);
                hideGate();
            }

            function showTypeformWall(email) {
                currentUserEmail = email;
                showView('typeform');
            }

            function showCalendlyWall() {
                showView('calendly');
            }

            // ============================================
            // MAIN INIT
            // ============================================
            async function init() {
                try {
                    // Show loading while checking
                    showView('loading');
                    showGate();

                    // 1. Fetch tier limits
                    const { data: settings } = await supabase
                        .from('global_settings')
                        .select('key, value')
                        .in('key', ['TIER1_LIMIT', 'TIER2_LIMIT']);

                    if (settings && settings.length > 0) {
                        const config = Object.fromEntries(settings.map(s => [s.key, parseInt(s.value)]));
                        LIMIT_TIER1 = config.TIER1_LIMIT || LIMIT_TIER1;
                        LIMIT_TIER2 = config.TIER2_LIMIT || LIMIT_TIER2;
                    }

                    // 2. Check session
                    const { data: { session } } = await supabase.auth.getSession();

                    if (!session) {
                        console.log('No session - showing request form');
                        showView('request');
                        return;
                    }

                    const userEmail = session.user.email.toLowerCase().trim();
                    currentUserEmail = userEmail;

                    // 3. Get user status
                    const { data: user, error: userError } = await supabase
                        .from('allowed_users')
                        .select('status, unlocks_count, email')
                        .eq('email', userEmail)
                        .single();

                    if (userError) {
                        console.error('User lookup error:', userError);
                        if (userError.code === 'PGRST116') {
                            // User authenticated but not in allowed_users - grant access
                            return grantAccess(userEmail);
                        }
                        showView('request');
                        return;
                    }

                    if (!user) {
                        showView('request');
                        return;
                    }

                    // 4. Golden Ticket check
                    if (promoReport && promoReport === currentSlug) {
                        return grantAccess(userEmail);
                    }

                    // 5. THE LADDER LOGIC
                    if (user.status === 'vip') {
                        return grantAccess(userEmail);
                    }

                    if (user.status === 'tier2') {
                        if (user.unlocks_count < LIMIT_TIER2) {
                            await supabase.rpc('increment_unlock', { user_email: userEmail });
                            return grantAccess(userEmail);
                        } else {
                            return showCalendlyWall();
                        }
                    }

                    if (user.status === 'tier1') {
                        if (user.unlocks_count < LIMIT_TIER1) {
                            await supabase.rpc('increment_unlock', { user_email: userEmail });
                            return grantAccess(userEmail);
                        } else {
                            return showTypeformWall(userEmail);
                        }
                    }

                    showView('request');

                } catch (err) {
                    console.error('Gating init error:', err);
                    showView('request');
                }
            }

            // Handle magic link callback
            async function handleAuthCallback() {
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const accessToken = hashParams.get('access_token');
                const refreshToken = hashParams.get('refresh_token');

                if (accessToken && refreshToken) {
                    const { error } = await supabase.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken
                    });
                    if (!error) {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }
            }

            // Auth state listener
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    init();
                }
            });

            // Start
            async function start() {
                await handleAuthCallback();
                await init();
            }
            start();
        })();
    </script>